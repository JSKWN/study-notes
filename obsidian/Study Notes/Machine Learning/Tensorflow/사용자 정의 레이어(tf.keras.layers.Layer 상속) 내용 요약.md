- [[#1. ê°œìš”|1. ê°œìš”]]
- [[#2. ì§€ì—°ëœ ì‹¤í–‰ (Lazy Execution)|2. ì§€ì—°ëœ ì‹¤í–‰ (Lazy Execution)]]
- [[#3. êµ¬ì„± ë©”ì„œë“œ|3. êµ¬ì„± ë©”ì„œë“œ]]
		- [[#a. `__init__`(self, **kwargs)|a. `__init__`(self, **kwargs)]]
		- [[#b. build(self, input_shape)|b. build(self, input_shape)]]
		- [[#c. call(self, inputs, training=None)|c. call(self, inputs, training=None)]]
		- [[#d. `get_config(self)`, `from_config()`|d. `get_config(self)`, `from_config()`]]
- [[#4. model ì €ì¥ì‹œ ë™ì‘ì›ë¦¬|4. model ì €ì¥ì‹œ ë™ì‘ì›ë¦¬]]
		- [[#`get_conifg()`, `from_config()` ê°œìš”|`get_conifg()`, `from_config()` ê°œìš”]]
- [[#5.ì˜ˆì‹œ ì½”ë“œ|5.ì˜ˆì‹œ ì½”ë“œ]]

## 1. ê°œìš”

**Tensorflowì˜`Layer`í´ë˜ìŠ¤ëŠ” ê°€ì¤‘ì¹˜ ë° ì—°ì‚°ì„ ìº¡ìŠí™”í•˜ëŠ” ê¸°ë³¸ ë‹¨ìœ„.**

ì‚¬ìš©ì ì •ì˜ ë ˆì´ì–´ ì‘ì„± ì‹œ, ë‘ ê°€ì§€ ê°œë…ì„ ìœ ì˜.

1. **ë³€ìˆ˜ ê´€ë¦¬(Variable Management)**: ê¸°ì¡´ì— ì—†ëŠ” ì‚¬ìš©ì ì •ì˜ ë ˆì´ì–´ ì‘ì„± ì‹œ ê°€ì¤‘ì¹˜ë¥¼ `add_weight()`ë¥¼ ì´ìš©í•´ `tf.Variable`ì´ ì¶”ì í•˜ë„ë¡ ë§Œë“¤ì–´ì•¼í•¨.
2. **ê·¸ë˜í”„ ì‹¤í–‰ í˜¸í™˜ì„±(Graph Execution Compatibility)**: íŒŒì´ì¬ ëŸ°íƒ€ì„ ì˜¤ë²„í—¤ë“œë¥¼ ìµœì†Œí™”í•˜ê³ , XLA ì»´íŒŒì¼ëŸ¬ ìµœì í™”ë¥¼ ì ìš©í•˜ê¸° ìœ„í•´, ëª¨ë“  ì—°ì‚°ì€ Tensorflow Opsë¡œ ì‘ì„±ë˜ì–´ì•¼ í•¨
	- ì˜¤ë²„í—¤ë“œ: ì‹¤ì œ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ì‹œê°„ì´ ì•„ë‹ˆë¼, ì—°ì‚°ì„ ì¤€ë¹„í•˜ê³  ëª…ë ¹ ì¤€ë¹„, í†µì‹  ë“±ì— ì†Œìš”ë˜ëŠ” ì‹œê°„ì„ ì˜ë¯¸ (íŒŒì´ì¬ì´ ì¸í„°í”„ë¦¬í„° ì–¸ì–´ì´ë¯€ë¡œ ì½”ë“œë¥¼ í•œì¤„ì”© í•´ì„, íƒ€ì…ì²´í¬, ë©”ëª¨ë¦¬ ê´€ë¦¬ ê³¼ì •ì´ ì»´íŒŒì¼ ì–¸ì–´ë³´ë‹¤ ëŠë¦¼)
		- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” Tensorflow ìì²´ì˜ Graph Executionì„ í™œìš© â†’ ì „ì²´ ì—°ì‚° ì§€ë„ë¥¼ C++ ë ˆë²¨ë¡œ ë„˜ê²¨ì„œ íŒŒì´ì¬ì˜ ê°œì…ì„ ì œê±°
	- TF ops â†’ í…ì„œí”Œë¡œìš° ê·¸ë˜í”„ë¥¼ êµ¬ì„±í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ ì—°ì‚° ë‹¨ìœ„
		- tf.add, tf.matmul ë“±. í…ì„œí”Œë¡œìš° ì»´íŒŒì¼ëŸ¬ëŠ” tf.*ë¡œ ì‘ì„±ëœ Opsë“¤ë§Œ ì¸ì‹í•˜ì—¬ ìµœì í™” ê°€ëŠ¥. numpyë‚˜ ì¼ë°˜ íŒŒì´ì¬ list ë“±ì˜ ì¡°ì‘ì´ ì„ì´ë©´ ê·¸ë˜í”„ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŒ.
		- ë°˜ë³µë¬¸ì—ì„œ ë™ì ìœ¼ë¡œ í¬ê¸°ê°€ ë³€í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ë£° ë•ŒëŠ” PythonÂ list.append()Â ëŒ€ì‹ Â tf.TensorArrayë¥¼ ì¨ì•¼ ê·¸ë˜í”„ ëª¨ë“œì—ì„œ ì •ìƒ ì‘ë™

## 2. ì§€ì—°ëœ ì‹¤í–‰ (Lazy Execution)

**ê°€ì¤‘ì¹˜ ìƒì„±ì„ ê°ì²´ ìƒì„± ì‹œì (__init__)ì´ ì•„ë‹Œ, ë°ì´í„°ê°€ ì²˜ìŒ ë“¤ì–´ì˜¤ëŠ” ì‹œì (build)ê¹Œì§€ ë¯¸ë£¨ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.**

- **ì´ìœ :**Â ì…ë ¥ ë°ì´í„°ì˜ í˜•íƒœ(Shape)ë¥¼ ì•Œê¸° ì „ê¹Œì§€ëŠ” ê°€ì¤‘ì¹˜ í–‰ë ¬ì˜ í¬ê¸°ë¥¼ ê²°ì •í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
    
- **ë™ì‘:**Â ë ˆì´ì–´ ê°ì²´ì˜Â build()ê°€ ì‹¤í–‰ë˜ì–´ì•¼ ë¹„ë¡œì†ŒÂ **1) ë©”ëª¨ë¦¬ í• ë‹¹, 2) ê°€ì¤‘ì¹˜ ì´ˆê¸°í™”, 3) ë³€ìˆ˜ ì¶”ì **ì´ ì‹œì‘ë©ë‹ˆë‹¤.
## 3. êµ¬ì„± ë©”ì„œë“œ

#### a. `__init__`(self, **kwargs)
- `super().__init__(**kwargs)`ë¥¼ ì´ìš©í•´ ë¶€ëª¨ í´ë˜ìŠ¤(Layer)ë¥¼ ì´ˆê¸°í™” 
- ì‚¬ìš©í•  í•˜ìœ„ ë ˆì´ì–´ ê°ì²´ë¥¼ ë©¤ë²„ë³€ìˆ˜ë¡œ ì •ì˜
- í•˜ì´í¼íŒŒë¼ë¯¸í„°ë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ì €ì¥

#### b. build(self, input_shape)
- ê´€ë ¨ ë©”ì„œë“œ: `add_weight`: ê°€ì¤‘ì¹˜ê°€ ë“¤ì–´ê°ˆ ë¹ˆ ê³µê°„(í…ì„œ)ì„ ë§Œë“¤ê³ , ì´ˆê¸°ê°’ì„ ë¶€ì—¬í•œ ë’¤, ì¶”ì í•˜ëŠ” ì—­í• 
	- **ë©”ëª¨ë¦¬ ê³µê°„ í™•ë³´, ê°€ì¤‘ì¹˜ ì´ˆê¸°ê°’ ë¶€ì—¬, ë³€ìˆ˜ ì¶”ì **
	- `shape`ì¸ì: shapeë¡œ ì…ë ¥ë°›ì€ ì°¨ì› í˜•íƒœ ë° dtype ë§Œí¼ì˜ GPU ë©”ëª¨ë¦¬ ì˜ì—­ í™•ë³´
	- `initializer`ì¸ì: ì§€ì •ëœ ì•Œê³ ë¦¬ì¦˜(e.g. `random_normal`, `glorot_uniform`)ì„ ì´ìš©í•˜ì—¬ ê°€ì¤‘ì¹˜ ê°’ì„ ì´ˆê¸°í™”
	- `trainable=True`ì¸ì: tf.Variable
- Tensorflow()ì—ì„œ ë¯¸ë¦¬ ì •ì˜ëœ ë ˆì´ì–´(e.g. Conv2D, Dense)ë¥¼ ì‚¬ìš©ì ì •ì˜ ë ˆì´ì–´ì—ì„œ ë‹¤ì‹œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” add_weight ë° build() ë“± ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë¬´ë°© 
	- í•˜ìœ„ ë ˆì´ì–´ì—ì„œ build()ë¥¼ ë¯¸ë¦¬ ì •ì˜í–ˆì„ ê²½ìš°ì—ë„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™€ ì‚¬ìš©

- super().build(input_shape): ë©”ì„œë“œ ë§ˆì§€ë§‰ì— ë°˜ë“œì‹œ í˜¸ì¶œí•˜ì—¬Â self.built = TrueÂ í”Œë˜ê·¸ë¥¼ í™œì„±í™”í•´ì•¼í•¨
	- built == False ì¸ ê²½ìš°, ê°€ì¤‘ì¹˜ê°€ ì—†ë‹¤ê³  íŒë‹¨í•˜ì—¬ build()ë¥¼ ì‹¤í–‰í•˜ê²Œ ë¨

- (í˜¸ì¶œì‹œ) ìë™ìœ¼ë¡œ `build()`ê°€ ì‹¤í–‰ë˜ëŠ” ê²½ìš°
	- `fit()`, `predict()`, `evaluate()`ë“±ì„ í˜¸ì¶œí•˜ë©´ ë°ì´í„°ê°€ ëª¨ë¸ì— ì§„ì…í•˜ëŠ” ìˆœê°„ ìë™ìœ¼ë¡œ `build()`ê°€ ì‹¤í–‰ë¨. ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ì¼ì€ `model.summary()`ë¡œ êµ¬ì¡°ë¥¼ ë³´ê±°ë‚˜, ë¯¸ë¦¬ ê°€ì¤‘ì¹˜ë¥¼ ì´ˆê¸°í™” í•´ì•¼í•˜ëŠ” ê²½ìš°ë¥¼ ì œì™¸í•˜ë©´ ì˜ ì—†ìŒ. 
	

#### c. call(self, inputs, training=None)
- ìˆœë°©í–¥ì „íŒŒ(ì‹¤ì œ ì—°ì‚°)ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë©”ì„œë“œ, ê°€ì¤‘ì¹˜ ì°¸ì¡° ë° ì‚¬ìš©
- ì£¼ìš” ì¸ì:
	- `inputs`: ë ˆì´ì–´ë¡œ ë“¤ì–´ì˜¤ëŠ” ì…ë ¥ í…ì„œ
	- `training`: í•™ìŠµê³¼ ì¶”ë¡ ì‹œ ë™ì‘ì´ ë‹¤ë¥¸ ê²½ìš°, ë¶„ê¸° ì²˜ë¦¬ì— ì‚¬ìš©(TrueëŠ” í•™ìŠµëª¨ë“œ, FalseëŠ” ì¶”ë¡ ëª¨ë“œ)
	- `mask`: íŒ¨ë”©(padding)ì²˜ë¦¬ëœ ë¶€ë¶„(ì˜ë¯¸ ì—†ëŠ” 0)ì„ ì—°ì‚°ì—ì„œ ì œì™¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©
- tf ops ì‚¬ìš© ìœ ì˜:
	- call() ë‚´ë¶€ëŠ” `@tf.function`ì— ì˜í•´ ê·¸ë˜í”„ë¡œ ë³€í™˜ë˜ë¯€ë¡œ íŒŒì´ì¬ì˜ ê¸°ë³¸ ê¸°ëŠ¥ì¸ if, for, print ë³´ë‹¤ëŠ” TF ì—°ì‚°ì¸ tf.cond, tf.while_loop, tf.print ë“±ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „

#### d. `get_config(self)`, `from_config()`
**í´ë˜ìŠ¤ì˜ ìƒì„±ìì— ì‚¬ìš©ëœ ì¸ìë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜, ì¶”í›„ ëª¨ë¸ ë³µì›ì— ì‚¬ìš©**


## 4. model ì €ì¥ì‹œ ë™ì‘ì›ë¦¬
`model.save()`ë¥¼ ì‹¤í–‰í•  ê²½ìš°, KerasëŠ” ë‘ ê°€ì§€ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì €ì¥.
1. ê°€ì¤‘ì¹˜ (weights): í•™ìŠµëœ ê°€ì¤‘ì¹˜ ê°’ì´ë©°, `h5`, `checkpoint`í˜•íƒœë¡œ ì €ì¥
	- `h5`ì˜ êµ¬ì¡°: ì•„í‚¤í…ì²˜(json ë¬¸ìì—´)ì™€ ê°€ì¤‘ì¹˜ë¡œ ë‚˜ë‰¨
		- ì•„í‚¤í…ì²˜: ê° ë ˆì´ì–´, ëª¨ë¸ ë³„ ì‚¬ìš©ëœ í´ë˜ìŠ¤ ì´ë¦„, `__init__`ì— ë“¤ì–´ê°ˆ ì¸ìë“¤hidden_size=64,Â head_size=32) ë“±
		- ```JSON
			{
			  "class_name": "RelativeAttention3D",  // 1. í´ë˜ìŠ¤ ì´ë¦„
			  "config": {                           // 2. __init__ ì¸ìë“¤ (get_configì˜ ê²°ê³¼)
			    "hidden_size": 64,
			    "head_size": 32,
			    "name": "relative_attention_3d",
			    "trainable": true
			  },
			  ...
			}
		  ```
		- ë ˆì´ì–´ê°„ ì—°ê²°ê´€ê³„ì˜ ê²½ìš°, ì‚¬ìš©ì ì •ì˜ ë ˆì´ì–´(subclassing)ë¥¼ í™œìš©í–ˆì„ ê²½ìš° JSONì— ìë™ ì €ì¥ë˜ì§€ ì•ŠìŒ. ë”°ë¼ì„œ ë°˜ë“œì‹œ ì›ë˜ ëª¨ë¸ì„ êµ¬ì„±í• ë•Œ ì‘ì„±í–ˆë˜ ì†ŒìŠ¤ì½”ë“œê°€ í•„ìš”
			- Â KerasëŠ”Â callÂ í•¨ìˆ˜ ì•ˆì— ìˆëŠ”Â ifë¬¸,Â forë¬¸, ì—°ì‚° ìˆœì„œë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŒ

2. ì•„í‚¤í…ì²˜ (config): ëª¨ë¸ êµ¬ì¡° ë° í•˜ì´í¼íŒŒë¼ë¯¸í„°, json í˜•íƒœë¡œ ì €ì¥.
	- get_config()ëŠ” ëª¨ë¸ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ ë•Œ(`load_model`), configë¥¼ ë³´ê³  `__init__`ë©”ì„œë“œë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ì—¬ ê°ì²´ë¥¼ ìƒˆë¡œ ë§Œë“¦

#### `get_conifg()`, `from_config()` ê°œìš”
- `get_config()`ì˜ ì •í™•í•œ ì—­í• ì€ ìƒì„±ì(`__init__()`)ì— ì‚¬ìš©ëœ ì¸ìë¥¼ ì €ì¥í•˜ëŠ” ê²ƒ
	- ê°ì²´ì˜ ì´ˆê¸°í™” ë ˆì‹œí”¼
	- ğŸ”§ TensorFlow/Kerasì—ì„œ ì‚¬ìš©ì ì •ì˜ ë ˆì´ì–´ì˜ `get_config()` ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ë©´, ëª¨ë¸ ì €ì¥ ì‹œ í•´ë‹¹ ë ˆì´ì–´ì˜ ì„¤ì •(config)ì´ ëª¨ë¸ì˜ ì „ì²´ êµ¬ì„±ì— í¬í•¨ë˜ì–´ ìë™ìœ¼ë¡œ ì €ì¥?

- ğŸ”§ ì°¸ê³ ) `from_config()` ëŠ” ë¡œë“œ ì‹œ configë¡œë¶€í„° ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ìë™ í˜¸ì¶œ
	-  from_config()ëŠ” í´ë˜ìŠ¤ ë©”ì„œë“œ(`@classmethod`)ë¡œ êµ¬í˜„í•´ì•¼ í•¨
	- `load_model()`Â í˜¸ì¶œ â†’ - ì €ì¥ëœ configì—ì„œ í´ë˜ìŠ¤ ì •ë³´ í™•ì¸ â†’ í•´ë‹¹ í´ë˜ìŠ¤ì˜Â [from_config()](vscode-file://vscode-app/c:/Users/fnc/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)Â ìë™ í˜¸ì¶œ (`cls`ëŠ” ê° í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤) 

```Python
@classmethod
def from_config(cls, config): # í´ë˜ìŠ¤ ë©”ì„œë“œì˜ ê²½ìš°, selfì™€ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ í•˜ëŠ” clsë¥¼ ë°›ìŒ
	return cls(**config)

```


## 5.ì˜ˆì‹œ ì½”ë“œ
```Python
class MyLayer(tf.keras.layers.Layer):
    def __init__(self, filters):
        super(MyLayer, self).__init__()
        self.filters = filters
        self.conv1 = tf.keras.layers.Conv2D(filters, 3, padding='same')
        self.bn1 = tf.keras.layers.BatchNormalization()
        self.relu = tf.keras.layers.ReLU()

    def build(self, input_shape):
        # ì‚¬ìš©ì ì •ì˜ ê°€ì¤‘ì¹˜(Custom Weights) ìƒì„± (add_weight ì‚¬ìš©)
        self.alpha = self.add_weight(
            name='alpha_scale',
            shape=(self.filters,),        
            initializer='ones',          
            trainable=True                # í•™ìŠµ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        )
        
        super(MyHybridResBlock, self).build(input_shape)

    def call(self, inputs, training=False):
        # ìˆœë°©í–¥ì „íŒŒ(ë°ì´í„° íë¦„) êµ¬ì„±
        
        # tf ê¸°ì¡´ ì •ì˜ ë ˆì´ì–´
        x = self.conv1(inputs)
        x = self.bn1(x, training=training)
        x = self.relu(x)
        
        # ì‚¬ìš©ì ì •ì˜ ê°€ì¤‘ì¹˜
        # (Batch, H, W, Channel) * (Channel,) -> ë¸Œë¡œë“œìºìŠ¤íŒ… ê³±ì…ˆ
        x = x * self.alpha  
  
        return x

```